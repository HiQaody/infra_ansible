---
- name: Mettre à jour le système
  apt:
    update_cache: yes
    upgrade: dist

- name: Télécharger la dernière version de MinIO
  get_url:
    url: "{{ minio_bin_url }}"
    dest: /tmp/minio
    mode: '0755'

- name: Installer MinIO binaire
  copy:
    src: /tmp/minio
    dest: "{{ minio_bin_path }}"
    remote_src: yes
    mode: '0755'

- name: Créer l'utilisateur MinIO
  user:
    name: "{{ minio_user }}"
    system: yes
    shell: /sbin/nologin
    state: present

- name: Créer le dossier de stockage MinIO
  file:
    path: "{{ minio_storage_dir }}"
    state: directory
    owner: "{{ minio_user }}"
    group: "{{ minio_group }}"
    mode: '0755'

- name: Créer le fichier de configuration MinIO
  copy:
    dest: "{{ minio_env_file }}"
    content: |
      MINIO_ACCESS_KEY={{ minio_access_key }}
      MINIO_SECRET_KEY={{ minio_secret_key }}
    owner: root
    group: root
    mode: '0644'

- name: Créer le service systemd pour MinIO
  copy:
    dest: "{{ minio_service_file }}"
    content: |
      [Unit]
      Description=MinIO
      Documentation=https://docs.min.io
      Wants=network-online.target
      After=network-online.target

      [Service]
      User={{ minio_user }}
      Group={{ minio_group }}
      ExecStart={{ minio_bin_path }} server {{ minio_storage_dir }} --console-address ":{{ minio_console_port }}"
      EnvironmentFile={{ minio_env_file }}
      Restart=always
      LimitNOFILE=65536

      [Install]
      WantedBy=multi-user.target
    owner: root
    group: root
    mode: '0644'

- name: Recharger systemd
  command: systemctl daemon-reload

- name: Démarrer et activer MinIO
  service:
    name: minio
    state: started
    enabled: yes
